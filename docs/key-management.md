# Key management

This document provides a key management strategy using Yubico's [YubiHSM2][].
You may use it to manage private Ed25519 keys for log servers and witnesses.

[YubiHSM2]: https://developers.yubico.com/YubiHSM2/

## Preliminaries

Read Yubico's introductory documentation on [what is YubiHSM2][].  Pay extra
close attention to "Concepts" and "Commands".  You may also find it helpful to
read the [getting started guide][], as it shows some interactive example usage.

[what is YubiHSM2]: https://developers.yubico.com/YubiHSM2/
[getting started guide]: https://developers.yubico.com/YubiHSM2/Usage_Guides/YubiHSM_quick_start_tutorial.html

## Overview

The overall objectives are:

  1. Signing requires access to a localhost-only YubiHSM and a 128-bit secret
     generated while the device was (re)provisioned.  This _signing oracle
     YubiHSM_ is plugged into a networked node at all times (i.e., a primary log
     server, a secondary log server, or a witness), but is only usable as a
     signing oracle if a YubiHSM authentication passphrase is made available.
     The passphrase is only accessible as root if the node is in active-use.
  2. (Re)provisioning requires access to a _backup YubiHSM_ and a different
     128-bit secret.  Backup YubiHSMs are never plugged into a networked node;
     similarly, backup passphrases are never entered into a networked node.
  3. A single trusted operator can gain access to all YubiHSMs and the secret
     passphrases needed to make use of them.  However, backup YubiHSMs and their
     secret passphrases are never stored at rest in the same physical location.

These objectives imply a threat model where the trusted personnel is honest at
all times.  In other words, what we are trying to protect against are external
threats and failures.  Examples of threats include a device that gets physically
stolen or remotely accessible as a result of a networked node getting owned.
Examples of failures include a device that breaks.  We tolerate `n-1` failures,
with `n` set to `2` for backup YubiHSMs and `3` for USB sticks with passphrases.

For key recovery, the attacker needs to gain access to a backup YubiHSM and its
secret passphrases.  This is assumed to be hard: two physical security
boundaries need to be breached at the same time for the attacker to succeed.

For signing oracle access, a (local) attacker can steal a node's YubiHSM and
breach another physical security perimeter to gain access to its passphrases.
This, too, is assumed to be hard.

For signing oracle access, a (remote) attacker may gain root access on an active
node, or in the case of non-root access learn the secret passphrase by breaching
a physical security perimeter that stores it.  This may be the most likely
attack scenario.  It is also hard to detect if no physical boundary is breached.

For physical security and detection of breaches we rely on locks, alarms, safes,
tamper-evident bags, etc.  Detection of a breach is generally assumed to be
rapid and obvious; but as a defense-in-depth we also do a few routine checks.

## Description

### Secret passphrases

Secret passphrases are used for YubiHSM authentication and key wrapping.  These
secrets are always 64 hex-characters and generated by the YubiHSM's get-random.

Secret passphrases are stored redundantly on `n = 3` USB thumb drives.  Use
different models or vendors to reduce the likelihood of simultaneous failures.
There are very few storage requirements, at most a handful of secret passphrases
are needed.  We discourage `n < 3` to get a reasonable level of reliability.  

These USB thumb drives are stored in tamper-evident bags in the trusted
personnel's homes.  Use a safe for additional physical security.  Record the
tamper-evident bags' serial numbers in a private git repository.  Sync all
changes to this git repository between the trusted personnel out-of-band.

Below is an example of a table that could be tracked in a git repository.  E.g.,
before opening a tamper-evident bag and subsequently replacing it, one would
confirm with the others that they currently have and still get the same table.

| Date       | Storage location | Device | Serial number | Notes                    |
| ---------- | ---------------- | ------ | ------------- | ------------------------ |
| YYYY-MM-DD | Alice's home     | USB-1  | AAA           | Initial provisioning     |
| YYYY-MM-DD | Bob's home       | USB-2  | BBB           | Initial provisioning     |
| YYYY-MM-DD | Charlie's home   | USB-3  | CCC           | Initial provisioning     |
| YYYY-MM-DD | Alice's home     | USB-1  | DDD           | Promote logsrv secondary |

If a tamper-evident bag has been breached or stolen, all secret passphrases must
be changed as soon as possible.  This involves all backup and signing YubiHSMs.

If a USB thumb drive is plugged into a system that is not a dedicated
provisioning machine (introduced below), it should be considered compromised.

**Routine:** check safe and its tamper-evident bag once per month.

### Backup YubiHSMs

We have `n = 2` backup YubiHSMs that are complete replicates of each other:

  - An `authkey` object with all capabilities, delegated capabilities, and
    domains enabled.  This provides complete YubiHSM device access.
  - A `wrapkey` object for all domains but only with capabilities
    `import-wrapped,export-wrapped` and delegated capabilities
    `exportable-under-wrap,sign-eddsa`.  This provides the ability to export and
    import private Ed25519 keys in encrypted form between YubiHSM devices.
  - An `asymmetric-key` object with capabilities
    `exportable-under-wrap,sign-eddsa` and algorithm `ed25519`.  This can be
    used as the log server signing key.  It is placed in its own domain.
  - Another `asymmetric-key` object with capabilities
    `exportable-under-wrap,sign-eddsa` and algorithm `ed25519`.  This can be
    used as the witness signing key.  It is placed in its own domain.

(Storing the two signing keys in different domains is not necessary when each
networked node gets its own YubiHSM.  Such a setup makes it easier to change
this in the future though, i.e., if a signing oracle YubiHSM becomes shared.)

These four objects are generated on an initial YubiHSM, then exported and
imported under wrap to the other backup.  The secret passphrases associated with
`authkey` and `wrapkey` are stored on USB thumb drives as described above.

All of this takes place on a dedicated provisioning machine without network, to
avoid that the wrapped key material ever touches a networked node.  In other
words, always do the (wrapped) YubiHSM exporting and importing on this
provisioning machine.  Store it with the most accessible backup YubiHSM.

Store the two backup YubiHSMs in tamper-evident bags on different secure
locations.  Use the same procedure to track locations and serial numbers as for
USB sticks.  We discourage `n < 2` to get a reasonable level of reliability.

**Routine:** check that the most accessible backup YubiHSM (e.g., office) works
every three months.  Check all other backup YubiHSM replicas on a yearly basis.

### Signing oracle YubiHSMs

The signing oracle YubiHSMs get their key(s) imported under wrap while plugged
into the provisioning machine.  After import, the wrap key and the default
authentication key is deleted in favor of an authentication key that only
permits signing: capability `sign-eddsa` and delegated capabilities `none`.
The domain can be set to all or only to match the log server or witness key; it
does not really matter as no new key can be imported without reprovisioning.

Each signing oracle YubiHSM should have _its own_ `authkey` passphrase.
Assuming a primary log server, a secondary log server, and a witness, this
results in another three secrets to be stored on all USB thumb drives.

Only transfer secret passphrases to networked nodes that are in active use.  Do
this manually, and store them in files that require root privileges to access.

**Routine:** Automate checks that verify if a node's YubiHSM is plugged-in.
Delete passphrases that are stored on disk if a node becomes inactive.

## Getting started

### Equipment

  - 2x backup YubiHSMs
  - 1x signing oracle YubiHSM (primary log server)
  - 1x signing oracle YubiHSM (secondary log server)
  - 1x signing oracle YubiHSM (witness)
  - 3x USB thumb drives (different models/vendors)
  - 1x dedicated provisioning machine configured with [YubiHSM2 tooling][], the
    scripts for automation linked below, and no network access
  - 1x private git repository 
  - Many tamper-evident bags

[YubiHSM2 tooling]: https://github.com/Yubico/yubihsm-shell

### Locations

  - 2x physically secure sites for backup YubiHSMs and provisioning machine
  - 3x physically secure homes for USB thumb drives
  - Secure site(s) where the machines with online YubiHSMs are operated

The sites that contain backup and signing oracle YubiHSMs may be the same.

### Provision

Run the [provision](../scripts/provision) script and follow the instructions.
Take note of which YubiHSM serial number is provisioned with what.  Save stdout
output to each USB thumb drive: it's the secret passphrases described above.

If there's already a log server and witness ready to be deployed, transfer the
two authentication passphrases by logging in to the respective systems via SSH.
Transfer here means read them from the provisioning laptop and write manually.

Put offline YubiHSMs and USB thumb drives in tamper-evident bags.  Populate the
git repository table with initial information.  You may also want to save the
used [config](../scripts/config), which contains the exact object IDs and
domains that were selected when running the provision script.  You will need
those when configuring your log server and witness with signing oracle access.

Finally get the different YubiHSMs and USB thumb drives into their distinct
physically secure locations.  Store the provisioning machine with the most
accessible offline YubiHSM, so that it is available for routine checks etc.

XXX: makes sense to not plug USB thumb drive with backup passphrases into
anything but the provisioning machine.  But less so for other passphrases.

XXX: it might be worth saying something about the difference between gaining
remote access to log server and witness, both in terms of difficulty and impact.
