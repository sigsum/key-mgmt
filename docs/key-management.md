# Key management

This document provides a key management strategy using Yubico's [YubiHSM2][].
You may use it to manage private Ed25519 keys for log servers and witnesses.

[YubiHSM2]: https://developers.yubico.com/YubiHSM2/

**State:** work in progress.

## Preliminaries

Read Yubico's introductory documentation on [what is YubiHSM2][].  Pay extra
close attention to "Concepts" and "Commands".  You may also find it helpful to
read the [getting started guide][], as it shows some interactive example usage.

[what is YubiHSM2]: https://developers.yubico.com/YubiHSM2/
[getting started guide]: https://developers.yubico.com/YubiHSM2/Usage_Guides/YubiHSM_quick_start_tutorial.html

## Objective and threat model

The overall objectives are:

  1. Signing requires access to an online YubiHSM and a 128-bit secret generated
     while the device was (re)provisioned.  "Online" refers to the YubiHSM being
     plugged into a networked node that can _only_ be used as a signing oracle.
     An online YubiHSM can be plugged into its node at all times.  The secret
     needed to start signing can be transferred at a later time when needed.
  2. (Re)provisioning requires access to an offline YubiHSM and a different
     128-bit secret.  "Offline" refers to the YubiHSM never being plugged into a
     networked node.  You will need a provisioning machine without networking.
  3. A single trusted personnel can gain access to both online and offline
     YubiHSMs _and_ the secrets needed to work with them.  These secrets and
     YubiHSMs are however not stored at rest in the same physical location.  Any
     potential tampering and stealing by attackers is detectable after the fact.

These objectives imply a threat model where the trusted personnel is honest at
all times.  In other words, what we are trying to protect against is external
threats and failures.  Examples of threats include a USB thumb drive or a
YubiHSM that are physically stolen in isolation (but not both at the same time),
or a remote attacker that manages to break into a networked node (in which case
it might be possible to gain signing-oracle access but not to recover the key).
Examples of failures include USB thumb drives and YubiHSMs that somehow break.

For physical security we rely on locks, alarms, safes, etc.  It is assumed that
such breaches would be detected quickly, but in worst-case on routine checks.

## Description

### Secret passphrases

Secret passphrases are used for YubiHSM authentication and key wrapping.  These
secrets are always 64 hex-characters and generated by the YubiHSM's get-random.

Secret passphrases are stored redundantly on `n` USB thumb drives.  Use
different models or vendors to reduce the likelihood of simultaneous failures.
There are very few storage requirements, at most a handful of secret passphrases
are needed.  We discourage `n<3` to get a reasonable level of reliability.  

The trusted personnel get one USB thumb drive each.  These USB thumb drives are
stored in tamper-evident bags in the trusted personnel's homes.  Use a safe for
additional physical security.  Record the bags' serial numbers in a git
repository and sync all changes between the trusted personnel out-of-band.

Below is an example of a table that could be tracked in a git repository.  E.g.,
before opening a tamper-evident bag, one would confirm with the others that they
have the same table; both before and after to facilitate detection of a breach.

| Date       | Storage location | Device | Serial number | Notes                    |
| ---------- | ---------------- | ------ | ------------- | ------------------------ |
| YYYY-MM-DD | Alice's home     | USB-1  | AAA           | Initial provisioning     |
| YYYY-MM-DD | Bob's home       | USB-2  | BBB           | Initial provisioning     |
| YYYY-MM-DD | Charlie's home   | USB-3  | CCC           | Initial provisioning     |
| YYYY-MM-DD | Alice's home     | USB-1  | DDD           | Promote logsrv secondary |

If a tamper-evident bag has been breached or stolen, all secret passphrases must
be changed as soon as possible.  This involves all online and offline YubiHSMs.

**Routine:** check safe and its tamper-evident bag at minimum once per month.

### Offline YubiHSMs

The offline YubiHSMs are complete replicas of each other and configured with:

  - An `authkey` object with all capabilities, delegated capabilities, and
    domains enabled.  This provides complete YubiHSM device access.
  - A `wrapkey` object for all domains but only with capabilities
    `import-wrapped,export-wrapped` and delegated capabilities
    `exportable-under-wrap,sign-eddsa`.  This provides the ability to export and
    import private Ed25519 keys in encrypted form between YubiHSM devices.
  - An `asymmetric-key` object with capabilities
    `exportable-under-wrap,sign-eddsa` and algorithm `ed25519`.  This can be
    used as the log server signing key.  It is placed in its own domain.
  - Another `asymmetric-key` object with capabilities
    `exportable-under-wrap,sign-eddsa` and algorithm `ed25519`.  This can be
    used as the witness signing key.  It is placed in its own domain.

These four objects are generated on an initial offline YubiHSM, then added and
exported to any additional offline YubiHSMs.  The secret passphrases associated
with `authkey` and `wrapkey` are stored on USB thumb drives as described above.

Store the `n` offline YubiHSM in tamper-evident bags and different physically
secure locations.  For example, your office's safe may be a secure location.
We discourage `n<2` to get a reasonable level of reliability.  Use the same
procedure to track the location and serial numbers as for USB thumb drives.

**Routine:** check that the most accessible offline YubiHSM (e.g., office) works
every three months.  Check all other offline YubiHSM replicas on a yearly basis.

### Online YubiHSMs

The online YubiHSMs get their signing key(s) imported under wrap.  After import,
the wrap key and the default permissive authentication key is deleted in favor
of an authentication key that only permits signing (capabilities `sign-eddsa`
and delegated capabilities `none`) in a separate log or witness domain.

Each online YubiHSM has its own `authkey` passphrase, resulting in another three
passphrases that need to be stored on USB thumb drives (assuming the primary log
server, secondary log server, and witness all use their own dedicated YubiHSMs).

If additional keys need to be imported, the entire device must be reset and
reprovisioned due to the limited signing-oracle `authkey` capabilities.

**Routine:** store `authkey` passphrase on disk iff it is in active use.  For
example, don't deploy the passphrase to the secondary log server in advance.

## Getting started

### Equipment

  - 2x offline YubiHSMs
  - 1x online YubiHSM (primary log server)
  - 1x online YubiHSM (secondary log server)
  - 1x online YubiHSM (witness)
  - 3x USB thumb drives (different models/vendors)
  - 1x dedicated provisioning machine, configured with [YubiHSM2 tooling][]
  - 1x self-hosted git repository 
  - "Many" tamper-evident bags

[YubiHSM2 tooling]: https://github.com/Yubico/yubihsm-shell

### Locations

  - 2x physically secure sites for offline YubiHSMs
  - 3x physically secure homes for USB thumb drives
  - Secure site(s) where the machines with online YubiHSMs are operated

### Provision

Simply run the [provision](../scripts/provision) script and follow the
instructions.  Take note of which YubiHSM serial number is provisioned with
what.  Save stdout output to each USB thumb drive: it's the secret passphrases.

If there's already a log server and witness ready to be deployed, transfer the
two authentication passphrases by logging in to the respective systems via SSH.
Transfer here means read them from the provisioning laptop and write manually.

Put offline YubiHSMs and USB thumb drives in tamper-evident bags.  Populate the
git repository table with initial information.  You may also want to save the
used [config](../scripts/config), which contains the exact object IDs and
domains that were selected when running the provision script.  You will need
those when configuring your log server and witness with signing oracle access.

Finally get the different YubiHSMs and USB thumb drives into their distinct
physically secure locations.  Store the provisioning machine with the most
accessible offline YubiHSM, so that it is available for routine checks etc.
